<!DOCTYPE html>
<html lang="en">
<head>
    <title>.FM</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <link type="text/css" rel="stylesheet" href="static/main.css">
    <style>
        #overlay {
            position: absolute;
            z-index: 1;
            top: 0;
            left: 0;
            width: 100%;
            height:100%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
            background-color: #000000;
            color: #ffffff;
        }

        #overlay > div {
            text-align: center;
        }

        #overlay > div > button {
            height: 20px;
            width: 100px;
            background: transparent;
            color: #ffffff;
            outline: 1px solid #ffffff;
            border: 0px;
            cursor: pointer;
        }

        #overlay > div > p {
            color: #777777;
            font-size: 12px;
        }
    </style>
</head>
<body>
<div id="overlay">
    <div>
        <button id="startButton">Lookup</button>
        <p>Click it to find FM stations!</p>
    </div>
</div>
<div id="info">
    .FM (sphere is a station)<br/></br>
    navigate with WASD / arrows / mouse
</div>

<script type="module">

    import * as THREE from './static/three.module.js';

    import { FirstPersonControls } from './static/FirstPersonControls.js';

    let lastRequest;

    function check_location(x, y){
        $.get("lookup")
    }

    let camera, controls, scene, renderer, light;

    let material1, material2, material3;

    let analyser1, analyser2, analyser3;

    const clock = new THREE.Clock();

    const startButton = document.getElementById('startButton');
    startButton.addEventListener( 'click', init );

    function init() {

        const overlay = document.getElementById('overlay');
        overlay.remove();

        camera = new THREE.PerspectiveCamera( 50, window.innerWidth / window.innerHeight, 1, 10000 );
        camera.position.set( 0, 25, 0 );

        const listener = new THREE.AudioListener();
        camera.add( listener );

        scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2( 0x000000, 0.0025 );

        light = new THREE.DirectionalLight( 0xffffff );
        light.position.set( 0, 0.5, 1 ).normalize();
        scene.add( light );

        const sphere = new THREE.SphereBufferGeometry(20, 32, 16);

        material1 = new THREE.MeshPhongMaterial( { color: 0xffaa00, flatShading: true, shininess: 0 } );
        material2 = new THREE.MeshPhongMaterial( { color: 0xff2200, flatShading: true, shininess: 0 } );
        material3 = new THREE.MeshPhongMaterial( { color: 0x6622aa, flatShading: true, shininess: 0 } );

        // sound spheres

        const audioLoader = new THREE.AudioLoader();

        const mesh1 = new THREE.Mesh(sphere, material1);
        mesh1.position.set( - 250, 30, 0 );
        scene.add( mesh1 );

        const sound1 = new THREE.PositionalAudio(listener);
        audioLoader.load( 'sounds/358232_j_s_song.ogg', function ( buffer ) {

            sound1.setBuffer( buffer );
            sound1.setRefDistance( 20 );
            sound1.play();

        } );
        mesh1.add( sound1 );

        //

        const mesh2 = new THREE.Mesh(sphere, material2);
        mesh2.position.set( 250, 30, 0 );
        scene.add( mesh2 );

        const sound2 = new THREE.PositionalAudio(listener);
        audioLoader.load( 'sounds/376737_Skullbeatz___Bad_Cat_Maste.ogg', function ( buffer ) {

            sound2.setBuffer( buffer );
            sound2.setRefDistance( 20 );
            sound2.play();

        } );
        mesh2.add( sound2 );

        //

        const mesh3 = new THREE.Mesh(sphere, material3);
        mesh3.position.set( 0, 30, - 250 );
        scene.add( mesh3 );

        const sound3 = new THREE.PositionalAudio(listener);
        const oscillator = listener.context.createOscillator();
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime( 144, sound3.context.currentTime );
        oscillator.start( 0 );
        sound3.setNodeSource( oscillator );
        sound3.setRefDistance( 20 );
        sound3.setVolume( 0.5 );
        mesh3.add( sound3 );

        // analysers

        analyser1 = new THREE.AudioAnalyser( sound1, 32 );
        analyser2 = new THREE.AudioAnalyser( sound2, 32 );
        analyser3 = new THREE.AudioAnalyser( sound3, 32 );

        // global ambient audio

        const sound4 = new THREE.Audio(listener);
        audioLoader.load( 'sounds/Project_Utopia.ogg', function ( buffer ) {

            sound4.setBuffer( buffer );
            sound4.setLoop( true );
            sound4.setVolume( 0.5 );
            sound4.play();

        } );

        // ground

        const helper = new THREE.GridHelper(1000, 10, "purple", "purple");
        helper.position.y = 0.1;
        scene.add( helper );



        renderer = new THREE.WebGLRenderer( { antialias: true } );
        renderer.setPixelRatio( window.devicePixelRatio );
        renderer.setSize( window.innerWidth, window.innerHeight );
        document.body.appendChild( renderer.domElement );

        //

        controls = new FirstPersonControls( camera, renderer.domElement );

        controls.movementSpeed = 70;
        controls.lookSpeed = 0.05;
        controls.noFly = true;
        controls.lookVertical = false;

        //

        window.addEventListener( 'resize', onWindowResize, false );

        animate();

    }

    function onWindowResize() {

        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();

        renderer.setSize( window.innerWidth, window.innerHeight );

        controls.handleResize();

    }

    function animate() {

        requestAnimationFrame( animate );
        render();

    }


    function render() {

        const delta = clock.getDelta();

        controls.update( delta );

        material1.emissive.b = analyser1.getAverageFrequency() / 256;
        material2.emissive.b = analyser2.getAverageFrequency() / 256;
        material3.emissive.b = analyser3.getAverageFrequency() / 256;

        renderer.render( scene, camera );

    }

</script>

</body>
</html>